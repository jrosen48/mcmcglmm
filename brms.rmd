---
title: "Using A Multivariate Model to Understand How Youths’ In-The-Moment Engagement Predicts Changes in Youths’ Interest"
author: "Joshua M. Rosenberg, Patrick N. Beymer, Thomas M. Houslay, and Jennifer A. Schmidt"
date: "3/27/2018"
output: html_document
---

```{r, setup-results-fix, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      collapse = TRUE,
                      fig.width = 6,
                      fig.asp = .618,
                      out.width = "80%", 
                      fig.align = "center", 
                      results = "hold", 
                      cache = TRUE) 

options(knitr.kable.NA = '')
set.seed(12345)
```

## Loading data, setting up

```{r, load-packages-load-data}
library(tidyverse)
library(brms)

d_red <- read_csv("processed-data/data-to-model.csv")
```

*Note to Tom*: Using results of `r2glmm::r2beta()` to calculate correlation between RM engagement (BLUP) and post-interestinterest; take square root of that value.

${ r }_{ BLUP-post-interest }$ = `r partial_corr`, accounting for their initial interest in STEM, their gender, and the nesting and cross-classification of youths’ responses.

### Super high-level summary of results from lme4

RM engagement (w/ BLUP) seems important; pre-interest seems important; gender female not quite important.

## 2B. Results using brms

```{r, MCMC-model, eval = FALSE}
d_for_m2 <- filter(d_red, !is.na(gender_female) & !is.na(pre_interest)) # # if there are missing vals in the fixed predictors, MCMCglmm gives a warning

d_for_m2 <- fill(d_for_m2, pre_interest, post_interest)

d_for_m2 <- d_for_m2 %>% 
  arrange(participant_ID, response_date, within_date_signal_number) %>%
  group_by(participant_ID) %>%
  mutate(sig_num = row_number())

# brms - not run

library(brms)
m3 <- brm(mvbind(rm_engagement, post_interest) ~ 
            gender_female + 
            pre_interest +
            (1|p|participant_ID) +
            (1|q|program_ID),
          data = d_for_m2, chains = 4, cores = 4, iter = 1000,
          control = list(adapt_delta = .999,
                         max_treedepth = 15))

```


```{r}
bf_1 <- bf(interest ~ gender_female + pre_interest + relevance + sig_num + (relevance + sig_num|p|participant_ID))
bf_2 <- bf(post_interest ~ gender_female + pre_interest + sig_num + (1|p|participant_ID))

m4 <- brm(bf_1 + bf_2,
          autocor = cor_ar(~ signal_number | participant_ID),
          data = d_for_m2, 
          chains = 4, cores = 4, iter = 1000)
```

```{r}
# ggplot(d_for_m2, aes(x = sig_num, y = interest, group = as.factor(participant_ID), color = as.factor(participant_ID))) +
#   geom_point() +
#   geom_smooth(method = 'lm', se = FALSE) +
#   theme(legend.position = "none")

bf_2_1 <- bf(interest ~ gender_female + pre_interest + sig_num + (relevance + sig_num|p|participant_ID) + (1|program_ID))
bf_2_2 <- bf(post_interest ~ gender_female + pre_interest + (1|p|participant_ID) + (1|program_ID))

m5 <- brm(bf_2_1 + bf_2_2,
          autocor = cor_ar(~ signal_number | participant_ID),
          data = d_for_m2, 
          chains = 4, cores = 4, iter = 1500)
```