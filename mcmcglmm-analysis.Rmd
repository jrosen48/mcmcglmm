---
title: "MCMCglmm results for AERA 2018"
author: "Joshua Rosenberg"
date: "3/27/2018"
output: html_document
---

```{r}
library(MCMCglmm)
library(lme4)
library(tidyverse)
```

```{r, setup-results-fix, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      message = FALSE, 
                      warning = FALSE, 
                      collapse = TRUE,
                      fig.width = 6,
                      fig.asp = .618,
                      out.width = "80%", 
                      fig.align = "center", 
                      results = "hold") 

options(knitr.kable.NA = '')
set.seed(12345)
```

# Engagement

## lme4

```{r}
m0i <- lmer(rm_engagement ~ 1  + pre_interest + gender_female + (1 | participant_ID), data = d_red)
konfound(m0i, pre_interest)
```

```{r}
library(lmerTest)
library(konfound)
m0i <- lmer(rm_engagement ~ 1  + pre_interest + gender_female + (1 | participant_ID), data = d_red)
konfound(m0i, pre_interest)

d_BLUP_2 <- ranef(m0i) %>% 
    pluck(1) %>% 
    rownames_to_column("participant_ID") %>% 
    mutate(participant_ID = as.integer(participant_ID)) %>% 
    rename(rm_engagement_BLUP = `(Intercept)`) 

d_ind_level_2 <- distinct(d, participant_ID, post_interest, program_ID, .keep_all = TRUE)
d_for_m2 <- left_join(d_ind_level_2, d_BLUP_2, by = "participant_ID")
d_for_m2 <- filter(d_for_m2, !is.na(post_interest) & !is.na(gender_female) & !is.na(urm) & !is.na(rm_engagement_BLUP))

m0ii <- lm(post_interest ~ 1 + rm_engagement_BLUP + gender_female + pre_interest, data = d_for_m2) 
konfound(m0ii, rm_engagement_BLUP)
konfound(m0ii, pre_interest)
summary(m0ii)
konfound::konfound(m0ii)

sjPlot::sjt.lmer(m0i, show.se = T)
r2beta(m0i)

summary(m0ii)
r2beta(m0ii)

sd(d_red$rm_engagement)
sd(d_red$post_interest, na.rm = T)
```

# MCMCglmm

```{r, cache = FALSE}
prior2 =list(R =list(V =diag(c(1,0.0001),2,2), nu = 0.002, fix = 2),
             G =list(G1 =list(V =diag(2), nu = 2,
                              alpha.mu =rep(0,2),
                              alpha.V =diag(25^2,2,2))))

m2 <- MCMCglmm(fixed = cbind(rm_engagement, post_interest) ~ trait - 1 + 
                   trait:gender_female + 
                   trait:pre_interest,
               random=~us(trait):participant_ID,
               rcov=~idh(trait):units, # this denotes response vars varying across response rows
               family = rep("gaussian",2),
               data=as.data.frame(d_red),
               prior=prior,
               burnin = 3000,
               nitt = 43000,
               thin = 40,
               verbose=TRUE)

summary(m2)

m2_cor <- m2$VCV[,"traitpost_interest:traitrm_engagement.participant_ID"]/
    (sqrt(m2$VCV[,"traitpost_interest:traitpost_interest.participant_ID"])*
         sqrt(m2$VCV[,"traitrm_engagement:traitrm_engagement.participant_ID"]))

broom::tidy(m2)
posterior.mode(m2_cor)
plot(m2_cor)
HPDinterval(m2_cor)
```

# Negative affect

## lme4

```{r}
m0i <- lmer(negative_affect ~ 1  + pre_interest + gender_female + (1 | participant_ID), data = d_red)

d_BLUP_2 <- ranef(m0i) %>% 
    pluck(1) %>% 
    rownames_to_column("participant_ID") %>% 
    mutate(participant_ID = as.integer(participant_ID)) %>% 
    rename(negative_affect_BLUP = `(Intercept)`) 

d_ind_level_2 <- distinct(d, participant_ID, post_interest, program_ID, .keep_all = TRUE)
d_for_m2 <- left_join(d_ind_level_2, d_BLUP_2, by = "participant_ID")
d_for_m2 <- filter(d_for_m2, !is.na(post_interest) & !is.na(gender_female) & !is.na(urm) & !is.na(negative_affect_BLUP))

m0ii <- lm(post_interest ~ 1 + negative_affect_BLUP + gender_female + pre_interest, data = d_for_m2) 

summary(m0i)
r2beta(m0i)

summary(m0ii)
r2beta(m0ii)
sqrt(.007)
```

# MCMCglmm

```{r, cache = FALSE}
prior = list(R = list(V = diag(2), nu = 0.002),
             G = list(G1 = list(V = diag(2), nu = 2, alpha.mu = rep(0,2),
                                alpha.V = diag(25^2,2,2))))

m3 <- MCMCglmm(fixed = cbind(negative_affect, post_interest) ~ trait - 1 +
                   trait:gender_female + 
                   trait:pre_interest,
               random=~us(trait):participant_ID,
               rcov=~corg(trait):units, # this denotes response vars varying across response rows
               family = rep("gaussian",2),
               data=as.data.frame(d_red),
               prior=prior,
               burnin = 3000,
               nitt = 23000,
               thin = 20,
               verbose=TRUE)
```

```{r}
summary(m3)

m3_cor <- m3$VCV[,"traitpost_interest:traitnegative_affect.participant_ID"]/
    (sqrt(m3$VCV[,"traitpost_interest:traitpost_interest.participant_ID"])*
         sqrt(m3$VCV[,"traitnegative_affect:traitnegative_affect.participant_ID"]))

broom::tidy(m3)
posterior.mode(m3_cor)
HPDinterval(m3_cor)
```

```{r, eval = F}
d1 <- d_red %>% 
    distinct(pre_interest, post_interest, participant_ID, .keep_all=T) %>% 
    psych::describe() %>% 
    as.data.frame() %>% 
    rownames_to_column("var") %>% 
    select(-trimmed, -mad, -se, -vars) %>% 
    filter(var %in% c("pre_interest", "post_interest"))

d2 <- d_red %>% 
    select(rm_engagement, negative_affect) %>% 
    psych::describe() %>% 
    as.data.frame() %>% 
    rownames_to_column("var") %>% 
    select(-trimmed, -mad, -se, -vars)

d3 <- bind_rows(d1, d2)
round3 <- function(x) round(x, 3)
d3 <- mutate_if(d3, is.double, round3)
clipr::write_clip(d3)

d_red <- d %>% 
    group_by(participant_ID, program_ID) %>% 
    mutate(rownum = row_number()) %>% 
    mutate(post_interest = ifelse(rownum == 1, post_interest, NA),
           pre_interest = ifelse(rownum ==1, pre_interest, NA))

d_red %>% 
    select(rm_engagement, negative_affect, pre_interest, post_interest) %>% 
    corrr::correlate() %>% 
    corrr::shave() %>% 
    corrr::fashion() %>% clipr::write_clip()

```
